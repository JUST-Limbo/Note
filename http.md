# http

## http缓存

### 强缓存和协商缓存

强缓存：浏览器不会像服务器发送任何请求，直接从本地缓存中读取文件并返回Status Code: 200 OK

![img](http.assets/16a8bdbc4b9c8720~tplv-t2oaga2asx-watermark.awebp)

> 200 form memory cache : 不访问服务器，一般已经加载过该资源且缓存在了内存当中，直接从内存中读取缓存。浏览器关闭后，数据将不存在（资源被释放掉了），再次打开相同的页面时，不会出现from memory cache。

> 200 from disk cache： 不访问服务器，已经在之前的某个时间加载过该资源，直接从硬盘中读取缓存，关闭浏览器后，数据依然存在，此资源不会随着该页面的关闭而释放掉下次打开仍然会是from disk cache。

> 优先访问memory cache,其次是disk cache，最后是请求网络资源

协商缓存: 向服务器发送请求，服务器会根据这个请求的request header的一些参数来判断是否命中协商缓存，如果命中，则返回304状态码并带上新的response header通知浏览器从缓存中读取资源

![img](http.assets/16a8bc3172e3a167~tplv-t2oaga2asx-watermark.awebp)

两类缓存规则可以同时存在，强制缓存优先级高于协商缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行协商缓存规则。



### expires

服务器和浏览器以GMT格式标准时间约定文件过期时间，用expires字段控制。下次请求时，请求时间小于服务端返回的到期时间则直接使用缓存（没有走到服务端）。

缺点：

1. 缓存过期后，不论目标文件是否产生过变化，都会再次读取目标文件并返回到浏览器
2. 服务器和浏览器时间可能不同步，缓存使用不精准

### Cache-Control

| 字段值   | 作用                                                         |
| -------- | ------------------------------------------------------------ |
| no-cache | 防止从缓存中返回过期的资源，所以使用之前，需要和源服务器发起请求比对过期时间 |
| no-store | 这个指令才是真正的不进行缓存，暗示请求报文中可能含有机密信息，不可缓存 |
| max-age  | 在指定时间内（单位秒），缓存服务器不再对资源的有效性进行确认，可以使用 |
| private  | 只有某个在通过缓存服务器的时候，得到缓存资源                 |
| public   | 所有的用户在通过缓存服务器的时候，都可以缓存这个资源。       |

针对浏览器和服务器时间不同步，加入了新的缓存方案；这次服务器不是直接告诉浏览器过期时间，而是告诉一个相对时间`max-age=10`，意思是10秒内，直接使用浏览器缓存。

![cache-control](http.assets/16531214de157f88~tplv-t2oaga2asx-watermark.awebp)

### Last-Modified / If-Modified-Since 

服务器比较请求头中的`If-Modified-Since `，如果一致则给出304状态码，不返回目标文件；如果不一致，则返回目标文件并告知浏览器目标文件最新的`Last-Modified`

缺点：

1. Last-Modified 过期时间只能精确到秒。无法应对同一秒内文件密集更新的情况
2. Last-Modified只匹配时间，不匹配文件内容。无法应对目标文件实际被覆盖然而内容前后未发生改变的情况

### Etag / If-None-Match

应对文件内容不变的情况，在服务器引入Etag响应头，

![img](http.assets/16a8c60fb0ef49f0~tplv-t2oaga2asx-watermark.awebp)

